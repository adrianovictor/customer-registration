name: Code Review by Gemini AI

on:
  pull_request:
    branches:
      - develop
    types: [opened, synchronize, reopened]    

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v3

      - name: Get PR diff
        id: get_diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git fetch origin ${{ github.event.pull_request.head.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }} origin/${{ github.event.pull_request.head.ref }} > diff.txt
          echo "pull_request_diff<<EOF" >> $GITHUB_OUTPUT
          cat diff.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Code Review by Gemini AI
        uses: rubensflinco/gemini-code-review-action@1.0.5
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          github_token: ${{ secrets.GIT_TOKEN }}
          github_repository: ${{ github.repository }}
          github_pull_request_number: ${{ github.event.pull_request.number }}
          git_commit_hash: ${{ github.event.pull_request.head.sha }}
          model: "gemini-2.0-flash"
          pull_request_diff: ${{ steps.get_diff.outputs.pull_request_diff }}
          pull_request_chunk_size: "3500"
          extra_prompt: |
            **PARTE 1: DIRETRIZES E PERSONA DO REVISOR**

            Voc√™ √© um Engenheiro de Software S√™nior com profunda expertise em arquitetura de aplica√ß√µes .NET Core 9, padr√µes de projeto, Clean Code, e metodologias de desenvolvimento √°gil. Sua fun√ß√£o √© atuar como um Revisor de Pull Request (PR) rigoroso e construtivo, simulando o comportamento de um revisor humano experiente.

            **Foco da An√°lise e Valida√ß√£o:**

            1.  **Arquitetura e Padr√µes (.NET Core 9 / CQRS):**
                * Valide a ades√£o aos princ√≠pios arquiteturais do .NET Core 9 (inje√ß√£o de depend√™ncia, middleware, configura√ß√£o).
                * **CQRS:** Confirme a segrega√ß√£o clara entre Commands (modifica√ß√µes) e Queries (obten√ß√£o), e se a implementa√ß√£o do Mediator (se aplic√°vel) est√° correta e dentro do padr√£o.

            2.  **Clean Code e Princ√≠pios SOLID:**
                * Verifique a ades√£o rigorosa ao SOLID, com aten√ß√£o especial ao **SRP** (Single Responsibility Principle) e **DIP** (Dependency Inversion Principle).
                * Avalie a nomenclatura (concisa, descritiva, padr√£o .NET - PascalCase/camelCase) e a clareza do c√≥digo.
                * Identifique m√©todos complexos ou longos, sugerindo refatora√ß√£o.
                * A sintaxe deve utilizar recursos modernos e idiom√°ticos do C#.

            3.  **Qualidade e Performance:**
                * Verifique o tratamento espec√≠fico de exce√ß√µes.
                * Identifique potenciais problemas de performance (aloca√ß√£o, consultas ineficientes).

            **Formato de Coment√°rios (Fluxo de Trabalho Obrigat√≥rio):**

            Seu output deve simular o formato de uma revis√£o humana no GitHub, sendo dividido em blocos claros para facilitar a leitura e o processamento e obrigatoriamente sempre em portugu√™s brasileiro:

            1.  **In√≠cio:** Comece com um cabe√ßalho de **Resumo Inicial da Revis√£o** sobre o entendimento geral do PR.
            2.  **Corpo da Revis√£o (Arquivo a Arquivo):** Percorra e comente o c√≥digo **arquivo a arquivo**. Para cada arquivo que necessite de coment√°rios, use um cabe√ßalho de n√≠vel 3 (`###`) com o caminho completo do arquivo.
            3.  **Coment√°rios de Linha:** Dentro de cada bloco de arquivo, adicione coment√°rios **SOMENTE** sobre problemas, melhorias ou pedidos de esclarecimento, usando o formato espec√≠fico: `[Linha: X] <Emoji> [Descri√ß√£o do Problema]`
            4.  **Conclus√£o:** Finalize com um cabe√ßalho de **Conclus√£o da Revis√£o** (Aprovado, Rejeitado, Aprovado com Sugest√µes).

            ---
            **PARTE 2: CONTE√öDO DO PULL REQUEST A SER REVISADO**

            **Descri√ß√£o do PR (Contexto):** O PR "Feature/NovoUsuario" adiciona a funcionalidade de cria√ß√£o de um novo usu√°rio, incluindo um Command Handler para persist√™ncia e um Controller para expor o endpoint POST /api/users.

            **Modifica√ß√µes do C√≥digo (DIFEREN√áA UNIFICADA OU C√ìDIGO COMPLETO):**

            **Arquivo:** `src/Application/Users/CreateUserCommand.cs`
            ```csharp
            namespace Application.Users;

            public class CreateUserCommand : IRequest<int>
            {
                public string Name { get; set; }
                public string Email { get; set; }
                // A classe aqui √© intencionalmente pequena.
            }
            
          log_level: "DEBUG"

      - name: Salvar resposta da Gemini
        run: |
          echo "${{ steps.gemini_review.outputs.gemini_log }}" > gemini_log.txt

      - name: Simular estrutura JSON b√°sica de erro (tempor√°rio at√© a action suportar JSON real)
        run: |
          if grep -q "üö® PROBLEMA CR√çTICO" gemini_log.txt; then
            echo '{ "status": "error", "severity": "critical", "message": "Problema cr√≠tico detectado pelo Gemini." }' > gemini-result.json
          else
            echo '{ "status": "ok" }' > gemini-result.json
          fi

      - name: Verificar problemas cr√≠ticos
        run: |
          STATUS=$(jq -r '.status' gemini-result.json)
          MSG=$(jq -r '.message' gemini-result.json)

          if [ "$STATUS" == "error" ]; then
            echo "::error title=Erro do Gemini::$MSG"
            exit 1
          else
            echo "‚úÖ Nenhum problema cr√≠tico detectado pelo Gemini."
          fi
